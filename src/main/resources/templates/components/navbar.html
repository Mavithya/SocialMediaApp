<nav th:fragment="navbar" class="navbar bg-white shadow-lg sticky top-0 z-50">
    <div class="navbar-start">
        <a class="btn btn-ghost normal-case text-3xl  font-bold !text-brand-500">Socialite</a>
    </div>
    <!-- SearchBar -->
    <div class="navbar-center hidden lg:flex">
        <div class="form-control relative">
            <form method="GET" action="/search" class="relative">
                <input type="text" name="q" id="navSearchInput" placeholder="Search posts, people..."
                       class="input input-bordered w-96 bg-white rounded-full border-gray-400 text-black placeholder-gray-400 focus:border-gray-400 pr-12" 
                       autocomplete="on" />
                <button type="submit" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
            </form>
            
            <!-- Search suggestions dropdown -->
            <div id="searchSuggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden z-50 max-h-96 overflow-y-auto">
                <div id="suggestionContent" class="p-2">
                </div>
            </div>
        </div>
    </div>
    <div class="navbar-end">
        <div class="flex items-center gap-4">
            <a th:href="@{/home}" class="btn btn-ghost btn-circle text-gray-600  bg-gray-200 hover:bg-gray-300">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                </svg>
            </a>
            <a th:href="@{/friends}" class="btn btn-ghost btn-circle text-gray-600  bg-gray-200 hover:bg-gray-300">

                <svg  viewBox="0 0 24 24" fill="currentColor" class="w-6 h-5">
                    <path d="M4.5 6.375a4.125 4.125 0 1 1 8.25 0 4.125 4.125 0 0 1-8.25 0ZM14.25 8.625a3.375 3.375 0 1 1 6.75 0 3.375 3.375 0 0 1-6.75 0ZM1.5 19.125a7.125 7.125 0 0 1 14.25 0v.003l-.001.119a.75.75 0 0 1-.363.63 13.067 13.067 0 0 1-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 0 1-.364-.63l-.001-.122ZM17.25 19.128l-.001.144a2.25 2.25 0 0 1-.233.96 10.088 10.088 0 0 0 5.06-1.01.75.75 0 0 0 .42-.643 4.875 4.875 0 0 0-6.957-4.611 8.586 8.586 0 0 1 1.71 5.157v.003Z" />
                </svg>


            </a>

            <!-- Notification Dropdown -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" id="notificationBtn" class="btn btn-ghost btn-circle relative text-gray-600 bg-gray-200 hover:bg-gray-300" role="button">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                    </svg>
                    <span id="notification-badge" class="badge badge-sm badge-primary absolute -top-1 -right-1 !bg-red-500 border-none hidden">0</span>
                </div>
                
                <!-- Notification Dropdown -->
                <div tabindex="0" id="notificationDropdown" class="dropdown-content mt-3 z-[100] card card-compact w-96 bg-white shadow-2xl border border-gray-200">
                    <div class="card-body p-0">
                        <!-- Header -->
                        <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-gradient-to-r from-brand-500 to-brand-600">
                            <h3 class="text-lg font-semibold text-white">Notifications</h3>
                            <button id="markAllReadBtn" class="btn btn-sm bg-white/20 text-white hover:bg-white/30 border-none">
                                Mark all as read
                            </button>
                        </div>
                        
                        <!-- Notifications List -->
                        <div id="notifications-list" class="max-h-96 overflow-y-auto">
                            <!-- Loading state -->
                            <div id="notifications-loading" class="flex items-center justify-center py-8">
                                <div class="loading loading-spinner loading-sm  w-[20px] h-[20px] text-black z-30" ></div>
                                <span class="ml-2 text-gray-500">Loading notifications...</span>
                            </div>
                            
                            <!-- Empty state -->
                            <div id="notifications-empty" class="hidden text-center py-8 px-4">
                                <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5-5-5h5V7a1 1 0 011-1h8a1 1 0 011 1v10z"></path>
                                </svg>
                                <p class="text-gray-500 font-medium">No notifications yet</p>
                                <p class="text-gray-400 text-sm">When someone interacts with your content, you'll see it here</p>
                            </div>
                            
                            <!-- Notifications container -->
                            <div id="notifications-container" class="divide-y divide-gray-100">
                                <!-- Dynamic notifications will be inserted here -->
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="p-4 bg-gray-50 border-t border-gray-200">
                            <button class="w-full btn btn-sm !bg-brand-500 text-white hover:bg-brand-600 border-none dark:!bg-brand-600 dark:!hover:bg-brand-700 transition-transform hover:scale-105 duration-200"
                                    onclick="window.location.href='/notifications'">
                                View All Notifications
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logout Button -->
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-circle text-gray-600 bg-gray-200 hover:bg-gray-300" title="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-logout">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" />
                        <path d="M9 12h12l-3 -3" />
                        <path d="M18 15l3 -3" />
                    </svg>
                </label>

                <div tabindex="0" class="dropdown-content mt-3 z-[100] card card-compact w-[255px] bg-white shadow-xl border border-gray-300">
                    <div class="card-body">
                        <div class="flex items-start gap-3 ">
                            <div class="w-10 h-10 mt-[6px] ml-[4px] bg-brand-500 rounded-2xl flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-brand-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                </svg>
                            </div>
                            <div class="flex-1 ">
                                <h3 class="font-semibold text-black text-base">Are you sure you want to logout?</h3>
                                <div class="flex mt-4 justify-end gap-2">
                                    <button onclick="document.activeElement.blur(); event.stopPropagation();"
                                            class="px-4 py-2 rounded-2xl bg-gray-200 text-gray-900 text-sm font-medium  hover:bg-gray-300 transition-transform hover:scale-105 duration-200">
                                        Cancel
                                    </button>
                                    <form th:action="@{/logout}" method="post" class="inline">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <button type="submit" class="px-4 py-2 !bg-brand-600 text-white text-sm font-medium rounded-2xl hover:!bg-brand-700  transition-transform hover:scale-105 duration-200">
                                            Yes
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<script>
// Search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('navSearchInput');
    const suggestionsDropdown = document.getElementById('searchSuggestions');
    const suggestionContent = document.getElementById('suggestionContent');
    let searchTimeout;

    if (searchInput && suggestionsDropdown && suggestionContent) {
        // Show suggestions on input
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            clearTimeout(searchTimeout);
            
            if (query.length >= 2) {
                searchTimeout = setTimeout(() => {
                    fetchSearchSuggestions(query);
                }, 300);
            } else {
                hideSuggestions();
            }
        });

        // Hide suggestions on focus out (with delay to allow clicking)
        searchInput.addEventListener('blur', function() {
            setTimeout(() => {
                hideSuggestions();
            }, 200);
        });

        // Show suggestions on focus if there's text
        searchInput.addEventListener('focus', function() {
            const query = this.value.trim();
            if (query.length >= 2) {
                fetchSearchSuggestions(query);
            }
        });

        // Handle Enter key
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    window.location.href = `/search?q=${encodeURIComponent(query)}`;
                }
                e.preventDefault();
            }
        });
    }

    function fetchSearchSuggestions(query) {
        const csrfToken = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
        const csrfHeader = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");
        
        const headers = {
            'X-Requested-With': 'XMLHttpRequest'
        };
        
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }
        
        fetch(`/search/api/suggestions?q=${encodeURIComponent(query)}`, {
            method: 'GET',
            headers: headers
        })
            .then(response => response.json())
            .then(data => {
                displaySuggestions(data, query);
            })
            .catch(error => {
                console.error('Error fetching suggestions:', error);
                hideSuggestions();
            });
    }

    function displaySuggestions(data, query) {
        let html = '';
        
        // Users section
        if (data.users && data.users.length > 0) {
            html += `<div class="mb-2">
                        <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 px-2">People</h4>`;
            
            data.users.forEach(user => {
                const avatar = user.profilePicture 
                    ? `<img src="/uploads/profiles/${user.profilePicture}" alt="${user.firstName} ${user.lastName}" class="w-8 h-8 rounded-full object-cover">`
                    : `<div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center">
                         <span class="text-white text-xs font-semibold">${user.firstName.charAt(0)}${user.lastName.charAt(0)}</span>
                       </div>`;
                
                html += `<div class="suggestion-item flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer" onclick="window.location.href='/search?q=${encodeURIComponent(user.firstName + ' ' + user.lastName)}&type=people'">
                            ${avatar}
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900">${user.firstName} ${user.lastName}</div>
                                ${user.username ? `<div class="text-xs text-gray-500">@${user.username}</div>` : ''}
                            </div>
                         </div>`;
            });
            html += '</div>';
        }

        // Posts section
        if (data.posts && data.posts.length > 0) {
            html += `<div class="mb-2">
                        <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 px-2">Posts</h4>`;
            
            data.posts.forEach(post => {
                const content = post.content.length > 50 ? post.content.substring(0, 50) + '...' : post.content;
                const avatar = post.user.profilePicture 
                    ? `<img src="/uploads/profiles/${post.user.profilePicture}" alt="${post.user.firstName} ${post.user.lastName}" class="w-6 h-6 rounded-full object-cover">`
                    : `<div class="w-6 h-6 rounded-full bg-blue-500 flex items-center justify-center">
                         <span class="text-white text-xs font-semibold">${post.user.firstName.charAt(0)}${post.user.lastName.charAt(0)}</span>
                       </div>`;
                
                html += `<div class="suggestion-item px-3 py-2 hover:bg-gray-50 cursor-pointer" onclick="window.location.href='/search?q=${encodeURIComponent(query)}&type=posts'">
                            <div class="flex items-start">
                                ${avatar}
                                <div class="ml-2 flex-1">
                                    <div class="text-xs text-gray-600">${post.user.firstName} ${post.user.lastName}</div>
                                    <div class="text-sm text-gray-900">${content}</div>
                                </div>
                            </div>
                         </div>`;
            });
            html += '</div>';
        }

        // View all results option
        if (html) {
            html += `<div class="border-t border-gray-200 pt-2 mt-2">
                        <div class="suggestion-item px-3 py-2 hover:bg-gray-50 cursor-pointer text-blue-600 font-medium" onclick="window.location.href='/search?q=${encodeURIComponent(query)}'">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                View all results for "${query}"
                            </div>
                         </div>
                     </div>`;
        }

        if (html) {
            suggestionContent.innerHTML = html;
            showSuggestions();
        } else {
            hideSuggestions();
        }
    }

    function showSuggestions() {
        suggestionsDropdown.classList.remove('hidden');
    }

    function hideSuggestions() {
        suggestionsDropdown.classList.add('hidden');
    }

    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsDropdown.contains(e.target)) {
            hideSuggestions();
        }
    });

    // Notification System
    initializeNotificationSystem();
});

// Notification System Functions
function initializeNotificationSystem() {
    const notificationBtn = document.getElementById('notificationBtn');
    const notificationDropdown = document.getElementById('notificationDropdown');
    const markAllReadBtn = document.getElementById('markAllReadBtn');
    
    if (!notificationBtn || !notificationDropdown) {
        console.warn('Notification elements not found');
        return;
    }
    
    console.log('Initializing notification system...');
    
    // Load notifications and update badge on page load
    loadNotifications();
    updateNotificationBadge();
    
    // Using DaisyUI dropdown with tabindex, so we just need to handle click to reload notifications
    notificationBtn.addEventListener('click', function() {
        console.log('Notification button clicked');
        loadNotifications(); // Refresh notifications when clicking
    });
    
    // Mark all as read functionality
    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            markAllNotificationsAsRead();
        });
    }
    
    // Make markNotificationAsRead globally available
    window.markNotificationAsRead = markNotificationAsRead;
    
    // Refresh notifications every 30 seconds
    setInterval(() => {
        updateNotificationBadge();
    }, 30000);
}

async function loadNotifications() {
    const loadingElement = document.getElementById('notifications-loading');
    const containerElement = document.getElementById('notifications-container');
    const emptyElement = document.getElementById('notifications-empty');

    if (!containerElement) {
        console.error('Notification container not found');
        return;
    }

    console.log('Loading notifications...');
    
    try {
        // Show loading state
        if (loadingElement) {
            loadingElement.classList.remove('hidden');
            console.log('✅ Loading spinner shown');
        }
        if (emptyElement) emptyElement.classList.add('hidden');
        containerElement.innerHTML = '';
        
        // Get CSRF token
        const csrfToken = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
        const csrfHeader = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");
        
        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };
        
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }
        
        const response = await fetch('/api/notifications?page=0&size=10', {
            method: 'GET',
            headers: headers,
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            console.error('API response not ok:', response.status, response.statusText);
            const errorText = await response.text();
            console.error('Error details:', errorText);
            throw new Error(`Failed to fetch notifications: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Notifications loaded:', data);
        
        // Hide loading state
        if (loadingElement) {
            loadingElement.classList.add('hidden');
            console.log('✅ Loading spinner hidden');
        }

        if (data.content && data.content.length > 0) {
            renderNotifications(data.content);
        } else {
            // Show empty state
            if (emptyElement) emptyElement.classList.remove('hidden');
        }
        
        // Update badge count at the same time
        updateNotificationBadge();
        
    } catch (error) {
        console.error('Error loading notifications:', error);
        if (loadingElement) loadingElement.classList.add('hidden');
        if (emptyElement) emptyElement.classList.remove('hidden');
    }
}

function renderNotifications(notifications) {
    const containerElement = document.getElementById('notifications-container');
    if (!containerElement) return;
    
    console.log('Rendering notifications:', notifications);
    
    const notificationHtml = notifications.map(notification => {
        const timeAgo = getTimeAgo(notification.createdAt);
        const isUnread = !notification.isRead;
        
        return `
            <div class="notification-item p-4 hover:bg-gray-50 cursor-pointer ${isUnread ? 'bg-blue-50 border-l-4 border-blue-500' : ''}" 
                 onclick="markNotificationAsRead(${notification.id})" 
                 data-notification-id="${notification.id}">
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        ${getNotificationIcon(notification.type)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 break-words">
                            ${notification.message}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">${timeAgo}</p>
                        ${isUnread ? '<div class="w-2 h-2 bg-blue-500 rounded-full mt-1"></div>' : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    containerElement.innerHTML = notificationHtml;
}

function getNotificationIcon(type) {
    const iconClasses = "w-8 h-8 p-1.5 rounded-full text-white";
    
    switch (type) {
        case 'POST_LIKED':
            return `<div class="${iconClasses} bg-red-500">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                        </svg>
                    </div>`;
        case 'POST_COMMENTED':
            return `<div class="${iconClasses} bg-blue-500">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                        </svg>
                    </div>`;
        case 'FRIEND_REQUEST_RECEIVED':
            return `<div class="${iconClasses} bg-green-500">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
                        </svg>
                    </div>`;
        case 'FRIEND_REQUEST_ACCEPTED':
            return `<div class="${iconClasses} bg-purple-500">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>`;
        case 'FRIEND_REQUEST_DECLINED':
            return `<div class="${iconClasses} bg-orange-500">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </div>`;
        case 'FRIEND_POST_CREATED':
            return `<div class="${iconClasses} bg-indigo-500">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                        </svg>
                    </div>`;
        default:
            return `<div class="${iconClasses} bg-gray-500">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                    </div>`;
    }
}

async function updateNotificationBadge() {
    try {
        console.log('Updating notification badge...');
        
        // Get CSRF token
        const csrfToken = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
        const csrfHeader = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");
        
        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };
        
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }
        
        const response = await fetch('/api/notifications/count', {
            method: 'GET',
            headers: headers,
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            console.error('Badge API response not ok:', response.status, response.statusText);
            const errorText = await response.text();
            console.error('Badge error details:', errorText);
            throw new Error(`Failed to fetch notification count: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Notification count:', data);
        
        const badge = document.getElementById('notificationBadge');
        
        if (badge) {
            if (data.unreadCount && data.unreadCount > 0) {
                badge.textContent = data.unreadCount > 99 ? '99+' : data.unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
    } catch (error) {
        console.error('Error updating notification badge:', error);
    }
}

async function markNotificationAsRead(notificationId) {
    try {
        console.log('Marking notification as read:', notificationId);
        const csrfToken = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
        const csrfHeader = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");
        
        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };
        
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }
        
        const response = await fetch(`/api/notifications/${notificationId}/read`, {
            method: 'POST',
            headers: headers,
            credentials: 'same-origin'
        });
        
        if (response.ok) {
            console.log('Notification marked as read successfully');
            // Update the notification item visually
            const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationElement) {
                notificationElement.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
                const unreadDot = notificationElement.querySelector('.w-2.h-2.bg-blue-500');
                if (unreadDot) {
                    unreadDot.remove();
                }
            }
            
            // Update badge count
            updateNotificationBadge();
        }
        
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}

async function markAllNotificationsAsRead() {
    try {
        console.log('Marking all notifications as read');
        const csrfToken = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
        const csrfHeader = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");
        
        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };
        
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }
        
        const response = await fetch('/api/notifications/read-all', {
            method: 'POST',
            headers: headers,
            credentials: 'same-origin'
        });
        
        if (response.ok) {
            console.log('All notifications marked as read successfully');
            // Reload notifications to reflect changes
            loadNotifications();
            updateNotificationBadge();
            
            // Show success message
            showToast('All notifications marked as read', 'success');
        }
        
    } catch (error) {
        console.error('Error marking all notifications as read:', error);
        showToast('Failed to mark notifications as read', 'error');
    }
}

function getTimeAgo(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diffInSeconds = Math.floor((now - time) / 1000);
    
    if (diffInSeconds < 60) {
        return 'Just now';
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes}m ago`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours}h ago`;
    } else if (diffInSeconds < 2592000) {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days}d ago`;
    } else {
        const months = Math.floor(diffInSeconds / 2592000);
        return `${months}mo ago`;
    }
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-[9999] transition-all duration-300 transform translate-x-full ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 10);
    
    // Remove toast after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}
</script>